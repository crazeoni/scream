<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Inline Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Welcome to Telegram Web App</h1>
    <p>Interact and send data back to the bot!</p>
    <button id="sendData">Send mData</button>
    
    <h1>Task Management</h1>
    <h3 id="rewardBalance">Rewards: 0 points</h3>
    <div id="taskList"></div>

    <script>
        const tg = window.Telegram.WebApp;
tg.expand(); // Expand to fullscreen

document.getElementById("sendData").addEventListener("click", async () => {
    // Extracting chat_id and username
    const data = {
        message: "Data from Web App",
        username: tg.initDataUnsafe.user.username,
        chat_id: tg.initDataUnsafe.user.id, // Pass chat_id dynamically
    };

    // Send data to your API endpoint
    const response = await fetch("https://telegram-mini-app-7nu1.onrender.com/api/send-data", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
    });

    if (response.ok) {
        const result = await response.json();
        tg.close(); // Close Web App on success
        alert(result.message); // Notify user
    } else {
        alert("Failed to send data!");
    }
});

// Fetch and display tasks
        async function fetchTasks() {
            // Replace with dynamic fetching from your backend
            const tasks = [
                { 
                    "id": 1, 
                    "title": "Follow us on Twitter", 
                    "reward": 500, 
                    "completed": false,
                    "links": [
                        "https://x.com/mid3e?task_id=1",
                        "https://x.com/mid3e?task_id=1&type=details",
                        "https://x.com/mid3e?task_id=1&action=complete"
                    ]
                },
                { 
                    "id": 2, 
                    "title": "Join our Telegram Channel", 
                    "reward": 700, 
                    "completed": false,
                    "links": [
                        "https://t.me/officialscream?task_id=2",
                        "https://t.me/officialscream?task_id=2&type=details",
                        "https://t.me/officialscream?task_id=2&action=complete"
                    ]
                },
                { 
                    "id": 3, 
                    "title": "Claim your first NFT", 
                    "reward": 1000, 
                    "completed": false,
                    "links": [
                        "https://t.me/screambot?task_id=3",
                        "https://t.me/screambot?task_id=3&type=details",
                        "https://t.me/screambot?task_id=3&action=complete"
                    ]
                },
            ];
            const taskList = document.getElementById("taskList");
            taskList.innerHTML = tasks
                .map((task) => 
                    '<div class="task">' +
    '<p>' +
        '<strong>' + task.title + '</strong> - Reward: ' + task.reward + ' points' +
    '</p>' +
    '<p>' +
        '<a href="' + task.links[0] + '" target="_blank" id="taskLink" style="display:none;">Task Link</a>' +
    '</p>' +
    '<button onclick="completeTask(' + task.id + ', \'' + task.links[0] + '\')" ' +
        (task.completed ? 'disabled' : '') +
    '>' +
        (task.completed ? 'Completed' : 'Open Task and Complete') +
    '</button>' +
'</div>'

                )
                .join("");
        }

        // Complete a task
        async function completeTask(taskId, taskLink) {
    const tg = window.Telegram.WebApp; // Get Telegram WebApp object
    const data = {
        task_id: taskId,
        chat_id: tg.initDataUnsafe.user.id, // Extract user's chat ID
    };

    const taskButton = event.target; // Get the clicked button
    const taskLinkElement = document.getElementById("taskLink"); // Get the task link element

    // If the task is not completed yet
    if (!taskButton.disabled) {
        // Open the task link
        window.open(taskLink, '_blank');

        // Disable the button after the first click to prevent reopening
        taskButton.disabled = true;
        taskButton.textContent = 'Completed'; // Change the button text to 'Completed'

        // Send the completion request for rewarding
        const response = await fetch("https://telegram-mini-app-7nu1.onrender.com/api/tasks/complete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        });

        if (response.ok) {
            const result = await response.json();
            alert(result.message);
            fetchTasks(); // Refresh task list
            fetchRewards(); // Update reward balance
        } else {
            alert("Failed to complete task!");
        }
    }
}


        // Fetch rewards and update the UI
        async function fetchRewards() {
            const tg = window.Telegram.WebApp;
            const response = await fetch(`https://telegram-mini-app-7nu1.onrender.com/api/get-balance?chat_id=${tg.initDataUnsafe.user.id}`);
            if (response.ok) {
                const balance = await response.json();
                document.getElementById("rewardBalance").textContent = `Rewards: ${balance.total} points`;
            }
        }

        // Initial load
        fetchTasks();
        fetchRewards();
    </script>
</body>
</html>
