<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Inline Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Welcome to Telegram Web App</h1>
    <p>Interact and send data back to the bot!</p>
    <button id="sendData">Send mData</button>
    
    <h1>Task Management</h1>
    <h3 id="rewardBalance">Rewards: 0 points</h3>
    <div id="taskList"></div>

    <script>
        const tg = window.Telegram.WebApp;
tg.expand(); // Expand to fullscreen

document.getElementById("sendData").addEventListener("click", async () => {
    // Extracting chat_id and username
    const data = {
        message: "Data from Web App",
        username: tg.initDataUnsafe.user.username,
        chat_id: tg.initDataUnsafe.user.id, // Pass chat_id dynamically
    };

    // Send data to your API endpoint
    const response = await fetch("https://telegram-mini-app-7nu1.onrender.com/api/send-data", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
    });

    if (response.ok) {
        const result = await response.json();
        tg.close(); // Close Web App on success
        alert(result.message); // Notify user
    } else {
        alert("Failed to send data!");
    }
});

// Fetch and display tasks
async function fetchTasks() {
    const response = await fetch("https://telegram-mini-app-7nu1.onrender.com/api/tasks");
    const tasks = await response.json();
    const taskList = document.getElementById("taskList");
    taskList.innerHTML = tasks
        .map(
            (task) => 
        '<div class="task">' +
            '<p>${task.title} - Reward: ${task.reward} points</p>' +
            '<button onclick="completeTask(${task.id})" ${' +
                'task.completed ? "disabled" : ""' +
            '}>${task.completed ? "Completed" : "Complete Task"}</button>'+
        '</div>'
        )
        .join("");
}

	// Complete a task
async function completeTask(taskId) {
    const tg = window.Telegram.WebApp; // Get Telegram WebApp object
    const data = {
        task_id: taskId,
        chat_id: tg.initDataUnsafe.user.id, // Extract user's chat ID
    };

    const response = await fetch("https://telegram-mini-app-7nu1.onrender.com/api/tasks/complete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
    });

    if (response.ok) {
        const result = await response.json();
        alert(result.message);
        fetchTasks(); // Refresh task list
        fetchRewards(); // Update reward balance
    } else {
        alert("Failed to complete task!");
    }
}

// Fetch rewards and update the UI
async function fetchRewards() {
    const tg = window.Telegram.WebApp;
    const response = await fetch(`https://telegram-mini-app-7nu1.onrender.com/api/get-balance?chat_id=${tg.initDataUnsafe.user.id}`);
    if (response.ok) {
        const balance = await response.json();
        document.getElementById("rewardBalance").textContent = `Rewards: ${balance.total} points`;
    }
}

// Initial load
fetchTasks();
fetchRewards();
    </script>
</body>
</html>
